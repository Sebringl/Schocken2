
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Aprés Ski Team - Schocken</title>
  <style>
    html { font-size: 20px; }
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; max-width: 700px; margin: auto; }
    .dice-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .die { font-size: 150px; cursor: pointer; padding: 15px; border: 3px solid transparent; border-radius: 10px; }
    .held { border-color: green; background-color: #eaffea; }
    button { padding: 12px 24px; font-size: 18px; margin: 10px; }
    input { font-size: 18px; padding: 5px 10px; margin: 5px; }
    #result, #throwCount, #playerDisplay { font-size: 20px; margin-top: 10px; }
    #leaderboard { text-align: left; margin-top: 20px; }
    #historyTable table {
      border-collapse: collapse;
      margin: auto;
      width: 100%;
      font-size: 0.9rem;
    }

  #historyTable th, #historyTable td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: center;
  }

  #historyTable th {
    background-color: #e0e0e0;
    font-weight: bold;
  }
    
  #historyTable tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  #historyTable td {
    min-width: 60px;
  }
    
  </style>
</head>
<body>
  <h1>Aprés Ski Team - Schocken</h1>
  <div id="setup">
    <p>Spieler:</p>
    <div id="nameInputs"></div>
    <button onclick="addPlayer()">+ Spieler hinzufügen</button>
    <br><br>
    <button onclick="startGame()">Spiel starten</button>
  </div>

  <div id="game" style="display:none;">
    <div id="playerDisplay"></div>
    <div class="dice-container">
      <div class="die" id="die0" onclick="toggleHoldOrConvert(0)">⚀</div>
      <div class="die" id="die1" onclick="toggleHoldOrConvert(1)">⚀</div>
      <div class="die" id="die2" onclick="toggleHoldOrConvert(2)">⚀</div>
    </div>
    <button onclick="rollDice()" id="rollBtn">Würfeln</button>
    <button onclick="endTurn()" id="endTurnBtn" disabled>Zug beenden</button>
    <button onclick="resetGame()">Neues Spiel</button>
    <div id="throwCount">Wurf: 0</div>
    <div id="roundDisplay" style="margin-top:10px; font-weight:bold;"></div>
    <div id="result"></div>
    <div id="leaderboard"></div>
    <div id="historyTable" style="margin-top: 20px;"></div>
  </div>

  <script>
    let players = [], scores = [], currentPlayer = 0, maxThrowsThisRound = 3;
    let throwCount = 0, dice = [null, null, null], held = [false, false, false], convertible = [false, false, false];
    let diceSymbols = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'], roundNumber = 0, history = [];
    let wins = [];
    let startPlayerIndex = 0;

    function addPlayer(name = "") {
      const index = document.querySelectorAll("#nameInputs .playerEntry").length;
      const container = document.getElementById("nameInputs");

      const div = document.createElement("div");
      div.className = "playerEntry";
      div.innerHTML = `
        Spieler ${index + 1}: 
        <input type="text" id="playerName${index}" value="${name || `Spieler ${index + 1}`}" />
        <button onclick="removePlayer(this)">–</button>
      `;

      container.appendChild(div);
    }

    function removePlayer(button) {
      const entry = button.parentElement;
      entry.remove();
      rebuildPlayerInputLabels();
    }

    function rebuildPlayerInputLabels() {
      const entries = document.querySelectorAll("#nameInputs .playerEntry");
      entries.forEach((entry, i) => {
        const input = entry.querySelector("input");
        input.id = `playerName${i}`;
        entry.firstChild.textContent = `Spieler ${i + 1}: `;
      });
    }

    function startGame() {
      const savedNames = [];
      players = [], roundNumber = 1, history = [[]];
      const nameInputs = document.querySelectorAll("#nameInputs input");
      for (let i = 0; i < nameInputs.length; i++) {
        const name = nameInputs[i].value || `Spieler ${i + 1}`;
        players.push(name);
        savedNames[i] = name;
      }
      localStorage.setItem("schockenPlayers", JSON.stringify(savedNames));
      scores = new Array(players.length).fill(null);
      wins = new Array(players.length).fill(0);

      document.getElementById("roundDisplay").textContent = "Runde: " + roundNumber;
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
      showPlayer(); updateDiceDisplay(); updateHistoryTable();
    }

        function toggleHoldOrConvert(index) {
            if (convertible[index] && throwCount < maxThrowsThisRound) {
                dice[index] = 1; convertible[index] = false; updateDiceDisplay(); return;
            }
            if (throwCount === 0 || throwCount >= maxThrowsThisRound) return;
            held[index] = !held[index]; updateDiceDisplay();
        }

        function rollDie() { return Math.floor(Math.random() * 6) + 1; }

        function rollDice() {
            if (throwCount >= maxThrowsThisRound) { document.getElementById("rollBtn").disabled = true; return; }
            let rolled = [];
            for (let i = 0; i < 3; i++) if (!held[i]) { dice[i] = rollDie(); rolled.push(i); }
            throwCount++; applyManualSixRule(rolled);  updateDiceDisplay(); 
            document.getElementById("throwCount").textContent = `Wurf: ${throwCount}`;
            document.getElementById("endTurnBtn").disabled = false;
            
            if (throwCount >= maxThrowsThisRound) { document.getElementById("rollBtn").disabled = true; }
        }

        function applyManualSixRule(indices) {
            let sixes = indices.filter(i => dice[i] === 6);
            convertible = [false, false, false];
            if (sixes.length >= 2 && throwCount < maxThrowsThisRound) {
                convertible[sixes[0]] = true;
                if (sixes.length >= 3) convertible[sixes[1]] = true;
            }
        }

        function endTurn() {
            if (currentPlayer === 0 && throwCount > 0) maxThrowsThisRound = Math.min(3, throwCount);
            const score = rateRoll(dice, throwCount, currentPlayer);
            scores[currentPlayer] = score;
            history[roundNumber - 1][currentPlayer] = {
                label: score.label,
                throws: score.throws
            };
            updateHistoryTable(); nextPlayer();
        }

        function nextPlayer() {
    currentPlayer++;

    if (currentPlayer >= players.length) {
        // Rundensieger ermitteln
        let list = scores.map((s, i) => ({ name: players[i], playerIndex: i, ...s }));

        list.sort((a, b) => {
            if (a.tier !== b.tier) return b.tier - a.tier;
            if (a.subvalue !== b.subvalue) return b.subvalue - a.subvalue;
            if (a.throws !== b.throws) return a.throws - b.throws;
            return a.playerIndex - b.playerIndex;
        });

        wins[list[0].playerIndex]++;
        localStorage.setItem("schockenWinner", list[0].name);

          // Startspieler der nächsten Runde: Verlierer (letzter in sortierter Liste)
        const loser = list[list.length - 1];
        startPlayerIndex = loser.playerIndex;

        prepareNextRound(); // Starte nächste Runde
        updateHistoryTable(); // Zeige aktualisierte Sieg-Kronen in Tabelle
    } else {
        // Nächster Spieler vorbereiten
        throwCount = 0;
        dice = [null, null, null];
        held = [false, false, false];
        convertible = [false, false, false];
        updateDiceDisplay();
        showPlayer();
    }
}

        function prepareNextRound() {
            throwCount = 0; currentPlayer = startPlayerIndex;;
            scores = new Array(players.length).fill(null); dice = [null, null, null];
            held = [false, false, false]; convertible = [false, false, false];
            document.getElementById("result").textContent = "";
            document.getElementById("throwCount").textContent = "Wurf: 0";
            maxThrowsThisRound = 3; history.push([]); roundNumber++;
            document.getElementById("roundDisplay").textContent = "Runde: " + roundNumber;
            showPlayer(); updateDiceDisplay();
        }

        function showPlayer() {
            document.getElementById("playerDisplay").textContent = `Am Zug: ${players[currentPlayer]}`;
            document.getElementById("result").textContent = "";
            document.getElementById("throwCount").textContent = "Wurf: 0";
            document.getElementById("rollBtn").disabled = false;
            document.getElementById("endTurnBtn").disabled = true;
            document.getElementById("rollBtn").textContent = `Würfeln (${maxThrowsThisRound})`;
        }

        function updateDiceDisplay() {
            for (let i = 0; i < 3; i++) {
                const el = document.getElementById("die" + i);
                el.textContent = (dice[i] === null) ? "□" : diceSymbols[dice[i] - 1];
                el.className = "die";
            if (held[i]) el.classList.add("held");
                }
        // Anzeige im Würfeln-Button aktualisieren
        const remaining = maxThrowsThisRound - throwCount;
        const rollBtn = document.getElementById("rollBtn");

        if (remaining > 0) {
            rollBtn.textContent = `Würfeln (${remaining})`;
        } else {
            rollBtn.textContent = "Würfeln";
          }            
            }
        }

        function rateRoll(dice, throws, playerIndex) {
            const [a, b, c] = dice.slice().sort((x, y) => y - x);
            let label, tier, subvalue;

            if (dice.includes(null)) {
                return {
                    label: "Ungültiger Wurf",
                    value: 0,
                    tier: -1,
                    subvalue: 0,
                    throws,
                    playerIndex
                };
           }

        const countOf1 = dice.filter(d => d === 1).length;
                
        if (countOf1 === 3) {
            label = "Schock Out";
            tier = 4; subvalue = 6;
        } else if (countOf1 === 2)  {
            label = `Schock ${c}`;
            tier = 3; subvalue = c;
        } else if (a === b && b === c) {
            label = "Pasch";
            tier = 2; subvalue = a;
        } else if (a - b === 1 && b - c === 1) {
            label = "Straße";
            tier = 1; subvalue = a;
        } else {
            label = `${a}${b}${c}`;
            tier = 0; subvalue = a + b + c;
        }

    return {
        label,
        value: tier * 1000 + subvalue,
        tier,
        subvalue,
        throws,
        playerIndex
    };
}
   

function updateHistoryTable() {

  
    if (!history.length) return;

    let html = "<h3>Punkteverlauf</h3><table border='1' style='margin:auto; border-collapse:collapse;'>";

    // Kopfzeile mit Spielernamen + Siegen
    html += "<tr><th rowspan='2'>Runde</th>";
    players.forEach((name, i) => {
        const winCount = wins[i];
        const displayName = winCount > 0 ? `${name} (${winCount} 👑)` : name;
        html += `<th colspan="2">${displayName}</th>`;
    });
    html += "</tr>";

    // Unter-Kopfzeile
    html += "<tr>";
    players.forEach(() => {
      html += "<th>🎲</th><th>🔁</th>";
    });
    html += "</tr>";

    // Rundenverlauf
    history.forEach((r, i) => {
        html += `<tr><td>${i + 1}</td>`;
        for (let j = 0; j < players.length; j++) {
            const entry = r[j];
            html += `<td>${entry ? entry.label : ""}</td><td style="text-align:center;">${entry ? entry.throws : ""}</td>`;
        }
        html += "</tr>";  // <--- HIER war der kaputte String
    });

    html += "</table>";
    document.getElementById("historyTable").innerHTML = html;
}


function resetGame() {
    const winner = document.querySelector("#leaderboard ol li");
    const winnerName = winner ? winner.textContent.split(':')[0] : null;
    const savedNames = JSON.parse(localStorage.getItem("schockenPlayers") || "[]");

    document.getElementById("nameInputs").innerHTML = "";
    savedNames.forEach(name => addPlayer(name));

    document.getElementById("setup").style.display = "block";
    document.getElementById("game").style.display = "none";

    roundNumber = 0;
    history = [];
}
    </script>
</body>
</html>
