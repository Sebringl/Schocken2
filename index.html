<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Klausberg-Schocken</title>
  <!--
    Grundlegende Styles f√ºr Schriftarten, Layout, W√ºrfelanzeige und sanfte Hintergrund-Transitions
  -->
  <style>
    html { font-size: 20px; }
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
      max-width: 700px;
      margin: auto;
      transition: background-color 0.4s ease;
    }

    /* Container f√ºr die drei W√ºrfel */
    .dice-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .die {
      font-size: 130px;
      cursor: pointer;
      padding: 15px;
      border: 2px solid transparent;
      border-radius: 10px;
    }
    .held { border-color: green; background-color: #eaffea; }

    button { padding: 12px 24px; font-size: 18px; margin: 10px; }
    input { font-size: 18px; padding: 5px 10px; margin: 5px; }

    #result, #throwCount, #playerDisplay { font-size: 20px; margin-top: 10px; }
    #leaderboard { text-align: left; margin-top: 20px; }

    /* Tabelle f√ºr Spielhistorie */
    #historyTable table {
      border-collapse: collapse;
      margin: auto;
      width: 100%;
      font-size: 0.9rem;
    }
    #historyTable th, #historyTable td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: center;
    }
    #historyTable th { background-color: #e0e0e0; font-weight: bold; }
    #historyTable tr:nth-child(even) { background-color: #f9f9f9; }
    #historyTable td { min-width: 60px; }

    /* Knopf zum manuellen n√§chsten Spieler */
    #rotateBtn {
      background: none;
      border: none;
      font-size: 0.9em;
      cursor: pointer;
      padding: 0;
      margin-left: 6px;
      vertical-align: middle;
      line-height: 1;
      height: 1em;
      width: 1em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    #rotateBtn:disabled { opacity: 0.3; cursor: default; }
    #rotateBtn:hover:not(:disabled) { transform: scale(1.1); }

    /* Entfernen-Button f√ºr Spielernamenfelder */
    .removeBtn {
      font-size: 16px;
      padding: 4px 10px;
      height: 34px;
      line-height: 1;
      vertical-align: middle;
      margin-left: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    input[type="text"] { height: 34px; font-size: 16px; padding: 4px 10px; }
  </style>
</head>
<body>
  <!-- Setup-Bereich: Spieler hinzuf√ºgen und Spiel starten -->
  <div id="setup">
    <div id="nameInputs"></div>
    <button onclick="addPlayer()">+ Spieler hinzuf√ºgen</button>
    <br><br>
    <button onclick="startGame()">Spiel starten</button>
  </div>

  <!-- Spielbereich: Nur nach Start sichtbar -->
  <div id="game" style="display:none;">
    <!-- Anzeige des aktuellen Spielers und manueller Wechsel -->
    <div id="playerControl" style="margin-top: 20px;">
      <h1 id="playerDisplay" style="font-size: 24px; margin-bottom: 0;">Am Zug: Spieler 1</h1>
      <div style="text-align: center; margin-top: 5px;">
        <button id="rotateBtn" onclick="rotatePlayer()" title="N√§chster Spieler">üîÑ</button>
      </div>
    </div>

    <!-- W√ºrfelanzeige und -interaktion -->
    <div class="dice-container">
      <div class="die" id="die0" onclick="toggleHoldOrConvert(0)">‚öÄ</div>
      <div class="die" id="die1" onclick="toggleHoldOrConvert(1)">‚öÄ</div>
      <div class="die" id="die2" onclick="toggleHoldOrConvert(2)">‚öÄ</div>
    </div>

    <!-- Steuerkn√∂pfe -->
    <button onclick="rollDice()" id="rollBtn">W√ºrfeln</button>
    <button onclick="endTurn()" id="endTurnBtn" disabled>Zug beenden</button>
    <button onclick="resetGame()">Neues Spiel</button>

    <!-- Statusanzeigen -->
    <div id="throwCount">Wurf: 0</div>
    <div id="roundDisplay" style="margin-top:10px; font-weight:bold;"></div>
    <div id="result"></div>
    <div id="leaderboard"></div>
    <div id="historyTable" style="margin-top: 20px;"></div>
  </div>

  <script>
    /* ======== Globale Variablen ======== */
    const diceSymbols = ['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'];
    const playerTextColors = ['#e6194b','#3cb44b','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6','#bcf60c','#fabebe','#008080'];
    const playerBgColors = ['#ffe5e5','#e5ffe5','#e5e5ff','#fff5e5','#f5e5ff','#e5ffff','#ffe5f5','#f5ffe5','#fff0e5','#e5f5ff'];

    let players = [], scores = [], wins = [];
    let currentPlayer = 0, startPlayerIndex = 0, playerTurnIndex = 0;
    let throwCount = 0, maxThrowsThisRound = 3;
    let dice = [null, null, null], held = [false, false, false], convertible = [false, false, false];
    let convertedThisTurn = false, convertedCount = 0, maxConvertibleThisTurn = 0;
    let manualRotationMode = true;
    let roundNumber = 0, history = [];

    /* ======== Spieler-Setup: Nameingabe und Farbanpassung ======== */
    function addPlayer(name = "") {
      const index = document.querySelectorAll("#nameInputs .playerEntry").length;
      const container = document.getElementById("nameInputs");
      const div = document.createElement("div");
      div.className = "playerEntry";
      div.innerHTML = `
        <input type="text" id="playerName${index}" value="${name || `Spieler ${index+1}`}" style="color:${playerTextColors[index] || '#000'};" />
        <button class="removeBtn" onclick="removePlayer(this)">‚Äì</button>
      `;
      container.appendChild(div);
    }
    function removePlayer(button) {
      button.parentElement.remove();
      rebuildPlayerInputLabels();
    }
    function rebuildPlayerInputLabels() {
      document.querySelectorAll("#nameInputs .playerEntry").forEach((entry, i) => {
        const inp = entry.querySelector("input");
        inp.id = `playerName${i}`;
        inp.style.color = playerTextColors[i] || '#000';
      });
    }

    addPlayer();
    addPlayer();

    function startGame() {
      const savedNames = [];
      players = [];
      roundNumber = 1;
      history = [[]];
      document.querySelectorAll("#nameInputs input").forEach((inp, i) => {
        players.push(inp.value || `Spieler ${i+1}`);
        savedNames[i] = inp.value;
      });
      localStorage.setItem("schockenPlayers", JSON.stringify(savedNames));
      scores = new Array(players.length).fill(null);
      wins = new Array(players.length).fill(0);

      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
      showPlayer();
      updateDiceDisplay();
      updateHistoryTable();
    }

    /* ======== W√ºrfel-Logik ======== */
    function rollDie() { return Math.floor(Math.random()*6)+1; }
    function applyManualSixRule(arr, heldArr) {
      convertible = [false,false,false];
      const fresh = arr.map((v,i)=>(v===6&&!heldArr[i])?i:null).filter(i=>i!==null);
      if(fresh.length<2) { maxConvertibleThisTurn=0; return; }
      maxConvertibleThisTurn = fresh.length===3?2:1;
      fresh.forEach(i=>convertible[i]=true);
    }
    function toggleHoldOrConvert(i) {
      if(dice[i]===null) return;
      const rem = maxThrowsThisRound - throwCount;
      if(dice[i]===6 && convertible[i] && !held[i]) {
        if(rem<=0) { alert("In der letzten Wurfrunde d√ºrfen keine Sechsen mehr getauscht werden."); return; }
        if(convertedCount<maxConvertibleThisTurn) {
          dice[i]=1; convertible[i]=false; convertedCount++; convertedThisTurn=true; updateDiceDisplay(); return;
        } else {
          held[i]=true; updateDiceDisplay(); return;
        }
      }
      held[i]=!held[i]; updateDiceDisplay();
    }
    function rollDice() {
      manualRotationMode=false;
      document.getElementById("rotateBtn").disabled=true;
      if(throwCount>=maxThrowsThisRound) return;
      convertedThisTurn=false; convertedCount=0;
      dice.forEach((v,i)=>{ if(!held[i]) dice[i]=rollDie(); });
      throwCount++; applyManualSixRule(dice,held); updateDiceDisplay();
      document.getElementById("endTurnBtn").disabled=false;
    }

    /* ======== Bewertungs- und Zug-Logik ======== */
    function rateRoll(d, t, idx) {
      const s=[...d].sort((a,b)=>b-a), [a,b2,c]=s;
      let label, tier, sub;
      const ones = s.filter(v=>v===1).length;
      if(ones===3) { label="Schock Out"; tier=4; sub=6; }
      else if(ones===2) { label=`Schock ${a}`; tier=3; sub=a; }
      else if(a===b2 && b2===c) { label="Pasch"; tier=2; sub=a; }
      else if(a-b2===1 && b2-c===1) { label="Stra√üe"; tier=1; sub=0; }
      else { label=`${a}-${b2}-${c}`; tier=0; sub=parseInt(`${a}${b2}${c}`); }
      return { label, value: tier*1000+sub, tier, subvalue:sub, throws:t, playerIndex:idx };
    }
    function endTurn() {
      scores[currentPlayer]=rateRoll(dice,throwCount,currentPlayer);
      history[roundNumber-1][currentPlayer]=scores[currentPlayer];
      updateHistoryTable();
      nextPlayer();
    }
    function nextPlayer() {
      playerTurnIndex++;
      if(playerTurnIndex<players.length) {
        currentPlayer=(startPlayerIndex+playerTurnIndex)%players.length;
        resetTurnState();
        showPlayer(); updateDiceDisplay();
      } else {
        const list=scores.map((s,i)=>({name:players[i],idx:i,...s}));
        list.sort((a,b)=>b.value-a.value||a.throws-b.throws||a.idx-b.idx);
        wins[list[0].idx]++;
        startPlayerIndex=list[list.length-1].idx;
        prepareNextRound(); updateHistoryTable();
      }
    }
    function resetTurnState() {
      throwCount=0;
      dice=[null,null,null]; held=[false,false,false]; convertible=[false,false,false];
      convertedThisTurn=false; convertedCount=0;
    }

    /* ======== Vorbereitung n√§chste Runde ======== */
    function prepareNextRound() {
      currentPlayer=startPlayerIndex;
      manualRotationMode=false;
      document.getElementById("rotateBtn").disabled=true;
      resetTurnState();
      document.getElementById("result").textContent="";
      maxThrowsThisRound=3;
      history.push(new Array(players.length).fill(null));
      roundNumber++;
      document.getElementById("roundDisplay").textContent="Runde: "+roundNumber;
      showPlayer(); updateDiceDisplay();
        playerTurnIndex = 0;                   // ‚Üê hier zur√ºcksetzen
    }
    function rotatePlayer() {
      if(!manualRotationMode) return;
      currentPlayer=(currentPlayer+1)%players.length;
      showPlayer();
    }

    /* ======== Anzeige-Funktionen ======== */
    function showPlayer() {
      document.getElementById("playerDisplay").textContent=`Am Zug: ${players[currentPlayer]}`;
      document.body.style.backgroundColor=playerBgColors[currentPlayer]||'#fff';
      document.getElementById("rollBtn").disabled=false;
      document.getElementById("endTurnBtn").disabled=true;
      document.getElementById("rollBtn").textContent=`W√ºrfeln (${maxThrowsThisRound-throwCount})`;
    }
    function updateDiceDisplay() {
      dice.forEach((v,i)=>{
        const el=document.getElementById(`die${i}`);
        el.textContent=v?diceSymbols[v-1]:'‚ñ°';
        el.className='die'; if(held[i]) el.classList.add('held');
      });
      const rem=maxThrowsThisRound-throwCount;
      document.getElementById("rollBtn").textContent=`W√ºrfeln (${rem})`;
      document.getElementById("rollBtn").disabled=!(rem>0 && !held.every(h=>h));
      const endBtn=document.getElementById("endTurnBtn");
      endBtn.disabled=convertedThisTurn && throwCount===0;
      document.getElementById("throwCount").textContent=`Wurf: ${throwCount}`;
    }

    /* ======== History- und Tabellen-Logik ======== */
    function updateHistoryTable() {
      if(!history.length) return;
      let html="<table border='1' style='margin:auto;border-collapse:collapse;'>";
      html+="<tr><th rowspan='2'>Runde</th>";
      players.forEach((n,i)=>{
        const wc=wins[i]?` (${wins[i]} üëë)`:'';
        html+=`<th colspan='2' style='color:${playerTextColors[i]||'#000'}'>${n}${wc}</th>`;
      });
      html+="</tr><tr>"+players.map(()=>"<th>üé≤</th><th>üîÅ</th>").join('')+"</tr>";
      for(let i=history.length-1;i>=0;i--){
        const r=history[i]; html+=`<tr><td>${i+1}</td>`;
        r.forEach(e=>{ html+=`<td>${e?e.label:''}</td><td>${e?e.throws:''}</td>`; });
        html+="</tr>";
      }
      html+="</table>";
      document.getElementById("historyTable").innerHTML=html;
    }

    function resetGame() {
      const saved=JSON.parse(localStorage.getItem("schockenPlayers")||"[]");
      document.getElementById("nameInputs").innerHTML='';
      saved.forEach(n=>addPlayer(n));
      document.getElementById("setup").style.display='block';
      document.getElementById("game").style.display='none';
      roundNumber=0; history=[];
    }
  </script>
</body>
</html>
