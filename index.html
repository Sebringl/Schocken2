
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Klausberg-Schocken</title>
  <style>
    html { font-size: 20px; }
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; max-width: 700px; margin: auto; }
    .dice-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
    .die { font-size: 150px; cursor: pointer; padding: 15px; border: 2px solid transparent; border-radius: 10px; }
    .held { border-color: green; background-color: #eaffea; }
    button { padding: 12px 24px; font-size: 18px; margin: 10px; }
    input { font-size: 18px; padding: 5px 10px; margin: 5px; }
    #result, #throwCount, #playerDisplay { font-size: 20px; margin-top: 10px; }
    #leaderboard { text-align: left; margin-top: 20px; }
    #historyTable table {
      border-collapse: collapse;
      margin: auto;
      width: 100%;
      font-size: 0.9rem;
    }

#rotateBtn {
  background: none;
  border: none;
  font-size: 0.9em;         /* kleinere Schriftgr√∂√üe */
  cursor: pointer;
  padding: 0;
  margin-left: 6px;
  vertical-align: middle;
  line-height: 1;
  height: 1em;
  width: 1em;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#rotateBtn:disabled {
  opacity: 0.3;
  cursor: default;
}
#rotateBtn:hover:not(:disabled) {
  transform: scale(1.1);
}

  #historyTable th, #historyTable td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: center;
  }

  #historyTable th {
    background-color: #e0e0e0;
    font-weight: bold;
  }
    
  #historyTable tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  #historyTable td {
    min-width: 60px;
  }

  /*Highlight-Stile f√ºr die Tabelle */
  .highlight-current {
    background-color: #eeeeee !important;
  }

  .highlight-roundbest {
    background-color: #fff4b8 !important;
  }

  .highlight-finalwinner {
    background-color: #ffe680 !important;
  }

  .removeBtn {
  font-size: 16px;
  padding: 4px 10px;
  height: 34px;
  line-height: 1;
  vertical-align: middle;
  margin-left: 6px;
  //background: none;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  }

  input[type="text"] {
  height: 34px;
  font-size: 16px;
  padding: 4px 10px;
  }
    
  </style>
</head>
<body>
  <div id="setup">
    <div id="nameInputs"></div>
    <button onclick="addPlayer()">+ Spieler hinzuf√ºgen</button>
    <br><br>
    <button onclick="startGame()">Spiel starten</button>
  </div>

  <div id="game" style="display:none;">
    <div id="playerControl" style="margin-top: 20px;">
      <h1 id="playerDisplay" style="font-size: 24px; margin-bottom: 0;">Am Zug: Spieler 1</h1>
      <div style="text-align: center; margin-top: 5px;">
      <button id="rotateBtn" onclick="rotatePlayer()" title="N√§chster Spieler">üîÑ</button>
    </div>
    </div>
    <div class="dice-container">
      <div class="die" id="die0" onclick="toggleHoldOrConvert(0)">‚öÄ</div>
      <div class="die" id="die1" onclick="toggleHoldOrConvert(1)">‚öÄ</div>
      <div class="die" id="die2" onclick="toggleHoldOrConvert(2)">‚öÄ</div>
    </div>
    <button onclick="rollDice()" id="rollBtn">W√ºrfeln</button>
    <button onclick="endTurn()" id="endTurnBtn" disabled>Zug beenden</button>
    <button onclick="resetGame()">Neues Spiel</button>
    <div id="throwCount">Wurf: 0</div>
    <div id="roundDisplay" style="margin-top:10px; font-weight:bold;"></div>
    <div id="result"></div>
    <div id="leaderboard"></div>
    <div id="historyTable" style="margin-top: 20px;"></div>
  </div>

  <script>
    let players = [], scores = [], currentPlayer = 0, maxThrowsThisRound = 3;
    let throwCount = 0, dice = [null, null, null], held = [false, false, false], convertible = [false, false, false];
    let diceSymbols = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'], roundNumber = 0, history = [];
    let wins = [];
    let startPlayerIndex = 0, playerTurnIndex = 0;
    let convertedThisTurn = false;
    let convertedCount = 0;
    let manualRotationMode = true;

    function addPlayer(name = "") {
      const index = document.querySelectorAll("#nameInputs .playerEntry").length;
      const container = document.getElementById("nameInputs");

      const div = document.createElement("div");
      div.className = "playerEntry";
      div.innerHTML = `
        <input type="text" id="playerName${index}" value="${name || `Spieler ${index + 1}`}" />
        <button class="removeBtn" onclick="removePlayer(this)">‚Äì</button>
      `;

      container.appendChild(div);
    }

    function removePlayer(button) {
      const entry = button.parentElement;
      entry.remove();
      rebuildPlayerInputLabels();
    }

    function rebuildPlayerInputLabels() {
      const entries = document.querySelectorAll("#nameInputs .playerEntry");
      entries.forEach((entry, i) => {
        const input = entry.querySelector("input");
        input.id = `playerName${i}`;
        //entry.firstChild.textContent = `Spieler ${i + 1}: `;
      });
    }

    function startGame() {
      const savedNames = [];
      players = [], roundNumber = 1, history = [[]];
      const nameInputs = document.querySelectorAll("#nameInputs input");
      for (let i = 0; i < nameInputs.length; i++) {
        const name = nameInputs[i].value || `Spieler ${i + 1}`;
        players.push(name);
        savedNames[i] = name;
      }
      localStorage.setItem("schockenPlayers", JSON.stringify(savedNames));
      scores = new Array(players.length).fill(null);
      wins = new Array(players.length).fill(0);

      //document.getElementById("roundDisplay").textContent = "Runde: " + roundNumber;
      document.getElementById("setup").style.display = "none";
      document.getElementById("game").style.display = "block";
      showPlayer(); updateDiceDisplay(); updateHistoryTable();
    }

 function toggleHoldOrConvert(index) {
  if (dice[index] === null) return;

  const remainingThrows = maxThrowsThisRound - throwCount;

  // Nur wenn die 6 konvertierbar ist (laut applyManualSixRule)
  if (dice[index] === 6 && !held[index] && convertible[index]) {
    if (remainingThrows <= 0) {
      alert("In der letzten Wurfrunde d√ºrfen keine Sechsen mehr getauscht werden.");
      return;
    }

    if (convertedCount >= 2) {
      alert("Du darfst maximal zwei Sechsen pro Runde in Einsen umwandeln.");
      return;
    }

    dice[index] = 1;
    // Achtung: NICHT automatisch festhalten
    convertible[index] = false;
    convertedCount++;
    convertedThisTurn = true;

    updateDiceDisplay();
    return;
  }

  // Normales Halten/Umschalten
  held[index] = !held[index];
  updateDiceDisplay();
}
  

        function rollDie() { return Math.floor(Math.random() * 6) + 1; }

        function rollDice() {
            manualRotationMode = false;
            document.getElementById("rotateBtn").disabled = true;
            convertedThisTurn = false;
            convertedCount = 0;
            if (throwCount >= maxThrowsThisRound) { document.getElementById("rollBtn").disabled = true; return; }
            let rolled = [];
            for (let i = 0; i < 3; i++) if (!held[i]) { dice[i] = rollDie(); rolled.push(i); }
            throwCount++; applyManualSixRule(rolled);  updateDiceDisplay(); 
            //document.getElementById("throwCount").textContent = `Wurf: ${throwCount}`;
            document.getElementById("endTurnBtn").disabled = false;
            
            if (throwCount >= maxThrowsThisRound) { document.getElementById("rollBtn").disabled = true; }
        }

        function applyManualSixRule(indices) {
            let sixes = indices.filter(i => dice[i] === 6);
            convertible = [false, false, false];
            if (sixes.length >= 2 && throwCount < maxThrowsThisRound) {
                convertible[sixes[0]] = true;
                if (sixes.length >= 3) convertible[sixes[1]] = true;
            }
        }

        function rotatePlayer() {
          if (!manualRotationMode) return;
          currentPlayer = (currentPlayer + 1) % players.length;
        showPlayer();
        }

        function endTurn() {
            if (currentPlayer === 0 && throwCount > 0) maxThrowsThisRound = Math.min(3, throwCount);
            const score = rateRoll(dice, throwCount, currentPlayer);
            scores[currentPlayer] = score;
            history[roundNumber - 1][currentPlayer] = {
                label: score.label,
                throws: score.throws
            };
            updateHistoryTable(); nextPlayer();
        }

    function nextPlayer() {
      playerTurnIndex++;

      if (playerTurnIndex < players.length) {
        // Bestimme n√§chsten Spieler im Uhrzeigersinn ab Startspieler
        currentPlayer = (startPlayerIndex + playerTurnIndex) % players.length;

        throwCount = 0;
        dice = [null, null, null];
        held = [false, false, false];
        convertible = [false, false, false];

        updateDiceDisplay();
        showPlayer();
      } else {
        // Runde beenden
        let list = scores.map((s, i) => ({ name: players[i], playerIndex: i, ...s }));

        list.sort((a, b) => {
          if (a.tier !== b.tier) return b.tier - a.tier;
          if (a.subvalue !== b.subvalue) return b.subvalue - a.subvalue;
          if (a.throws !== b.throws) return a.throws - b.throws;
          return a.playerIndex - b.playerIndex;
        });

        wins[list[0].playerIndex]++;
        localStorage.setItem("schockenWinner", list[0].name);

        const loser = list[list.length - 1];
        startPlayerIndex = loser.playerIndex;

        prepareNextRound();
        updateHistoryTable();
      }
    }

        function prepareNextRound() {
            manualRotationMode = true;
            document.getElementById("rotateBtn").disabled = false;
            throwCount = 0; 
            playerTurnIndex = 0;
            currentPlayer = startPlayerIndex;
            scores = new Array(players.length).fill(null); dice = [null, null, null];
            held = [false, false, false]; convertible = [false, false, false];
            document.getElementById("result").textContent = "";
            //document.getElementById("throwCount").textContent = "Wurf: 0";
            maxThrowsThisRound = 3; history.push(new Array(players.length).fill(null)); roundNumber++;
            document.getElementById("roundDisplay").textContent = "Runde: " + roundNumber;
            showPlayer(); updateDiceDisplay();   
        }

        function showPlayer() {
            document.getElementById("playerDisplay").textContent = `Am Zug: ${players[currentPlayer]}`;
            document.getElementById("result").textContent = "";
            //document.getElementById("throwCount").textContent = "Wurf: 0";
            document.getElementById("rollBtn").disabled = false;
            document.getElementById("endTurnBtn").disabled = true;
            document.getElementById("rollBtn").textContent = `W√ºrfeln (${maxThrowsThisRound})`;
        }
function updateDiceDisplay() {
    for (let i = 0; i < 3; i++) {
        const el = document.getElementById("die" + i);
        el.textContent = (dice[i] === null) ? "‚ñ°" : diceSymbols[dice[i] - 1];
        el.className = "die";
        if (held[i]) el.classList.add("held");
    }

    // Anzeige im W√ºrfeln-Button aktualisieren
    const remaining = maxThrowsThisRound - throwCount;
    const rollBtn = document.getElementById("rollBtn");
    const allHeld = held.every(h => h);

    if (remaining > 0) {
        rollBtn.textContent = `W√ºrfeln (${remaining})`;
        rollBtn.disabled = false;
    } else {
        rollBtn.textContent = "W√ºrfeln";
        rollBtn.disabled = true;
    }

    if (remaining > 0 && !allHeld) {
      rollBtn.textContent = `W√ºrfeln (${remaining})`;
      rollBtn.disabled = false;
    } else {
      rollBtn.textContent = "W√ºrfeln";
      rollBtn.disabled = true;
    } 
    const endBtn = document.getElementById("endTurnBtn");
      if (convertedThisTurn && throwCount === 0) {
      endBtn.disabled = true;
    } else {
      endBtn.disabled = false;
    }
  
}

        function rateRoll(dice, throws, playerIndex) {
            dice = dice.slice().sort((x, y) => y - x);
            const [a, b, c] = dice;
            let label, tier, subvalue;

            if (dice.includes(null)) {
                return {
                    label: "Ung√ºltiger Wurf",
                    value: 0,
                    tier: -1,
                    subvalue: 0,
                    throws,
                    playerIndex
                };
           }

        const countOf1 = dice.filter(d => d === 1).length;
                
        if (countOf1 === 3) {
            label = "Schock Out";
            tier = 4; subvalue = 6;
        } else if (countOf1 === 2)  {
            label = `Schock ${a}`;
            tier = 3; subvalue = a;
        } else if (a === b && b === c) {
            label = "Pasch";
            tier = 2; subvalue = a;
        } else if (a - b === 1 && b - c === 1) {
            label = "Stra√üe";
            tier = 1; subvalue = a;
        } else {
            label = `${a}-${b}-${c}`;
            tier = 0; subvalue = a + b + c;
        }

    return {
        label,
        value: tier * 1000 + subvalue,
        tier,
        subvalue,
        throws,
        playerIndex
    };
}

function getRoundBestPlayerIndex(round) {
  const entries = round
    .map((entry, i) => ({ ...entry, index: i }))
    .filter(e => e.label && typeof e.tier !== 'undefined');

  if (!entries.length) return null;

  entries.sort((a, b) => {
    if (a.tier !== b.tier) return b.tier - a.tier;
    if (a.subvalue !== b.subvalue) return b.subvalue - a.subvalue;
    if (a.throws !== b.throws) return a.throws - b.throws;
    return a.index - b.index;
  });

  return entries[0].index;
}

function getRoundWinner(round) {
  return getRoundBestPlayerIndex(round); // f√ºr fertige Runden verwenden wir dieselbe Logik
}

    

function updateHistoryTable() {

  
    if (!history.length) return;

    let html = "<h3></h3><table border='1' style='margin:auto; border-collapse:collapse;'>";

    // Kopfzeile mit Spielernamen + Siegen
    html += "<tr><th rowspan='2'>Runde</th>";
    players.forEach((name, i) => {
        const winCount = wins[i];
        const displayName = winCount > 0 ? `${name} (${winCount} üëë)` : name;
        html += `<th colspan="2">${displayName}</th>`;
    });
    html += "</tr>";

    // Unter-Kopfzeile
    html += "<tr>";
    players.forEach(() => {
      html += "<th>üé≤</th><th>üîÅ</th>";
    });
    html += "</tr>";

    // Rundenverlauf
    history.forEach((r, i) => {
        html += `<tr><td>${i + 1}</td>`;
      const currentRound = (i === roundNumber - 1);
      const currentBest = currentRound ? getRoundBestPlayerIndex(r) : null;
      const finalBest = (!currentRound && r.length) ? getRoundWinner(r) : null;

      for (let j = 0; j < players.length; j++) {
          const entry = r[j];
          let labelClass = "";
          if (entry) {
              if (entry) {
    if (j === currentBest && currentRound) {
        labelClass = "highlight-roundbest";
    } else if (currentPlayer === j && currentRound) {
        labelClass = "highlight-current";
    }

    if (j === finalBest && !currentRound) {
        labelClass = "highlight-finalwinner";
    }
}
              if (j === finalBest && !currentRound) labelClass = "highlight-finalwinner";
          }

          html += `<td class="${labelClass}">${entry ? entry.label : ""}</td>`;
          html += `<td class="${labelClass}" style="text-align:center;">${entry ? entry.throws : ""}</td>`;
      }

        html += "</tr>";  
    });

    html += "</table>";
    document.getElementById("historyTable").innerHTML = html;
}


function resetGame() {
    const winner = document.querySelector("#leaderboard ol li");
    const winnerName = winner ? winner.textContent.split(':')[0] : null;
    const savedNames = JSON.parse(localStorage.getItem("schockenPlayers") || "[]");

    document.getElementById("nameInputs").innerHTML = "";
    savedNames.forEach(name => addPlayer(name));

    document.getElementById("setup").style.display = "block";
    document.getElementById("game").style.display = "none";

    roundNumber = 0;
    history = [];
}
    </script>
</body>
</html>
